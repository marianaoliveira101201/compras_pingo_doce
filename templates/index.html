<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras Pingo Doce</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1, h2, h3 {
            font-family: 'Arial', sans-serif;
            color: #1a1a1a;
            text-align: center;
        }

        table {
            width: 60%;
            border-collapse: collapse;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px 18px;
            text-align: center;
        }

        th {
            background-color: #008A3F; /* Verde do Pingo Doce */
            color: white;
            font-size: 1.1em;
        }

        td {
            background-color: #fff;
            font-size: 1em;
        }

        td[contenteditable] {
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            transition: background-color 0.3s;
        }

        td[contenteditable]:focus {
            background-color: #e8f8e8;
            outline: none;
        }

        button {
            padding: 10px 20px;
            background-color: #008A3F; /* Verde do Pingo Doce */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-bottom: 20px;
            display: inline-block;
        }

        button:hover {
            background-color: #006B2F;
        }

        th:nth-child(1), td:nth-child(1) {
            width: 30%;
        }

        th:nth-child(2), td:nth-child(2) {
            width: 20%;
        }

        th:nth-child(3), td:nth-child(3) {
            width: 10%;
        }

        th:nth-child(4), td:nth-child(4) {
            width: 15%;
        }

        #total, #falta {
            color: #008A3F;
            font-weight: bold;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
        }

        .left-table, .right-table {
            width: 48%;
        }

        .add-line-btn, .remove-line-btn {
            cursor: pointer;
            background-color: #ff6f61;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .add-line-btn:hover, .remove-line-btn:hover {
            background-color: #e85f55;
        }

        .preco-estimado {
            color: #888; /* Cor cinza para indicar que é uma estimativa */
            font-style: italic; /* Itálico para maior diferenciação */
        }

        .riscado {
            text-decoration: line-through;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="left-table">
            <h1>Compras Pingo Doce</h1>

            <div style="text-align: center;">
                <button class="add-line-btn" onclick="adicionarLinha()">Adicionar Linha</button>
                <button class="remove-line-btn" onclick="removerLinha()">Remover Linha</button>
            </div>

            <h2>Itens Comprados</h2>
            <table id="tabelaItens">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Preço</th>
                        <th>Quantidade</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo">
                    <!-- Itens serão preenchidos aqui -->
                </tbody>
            </table>

            <h2>Total: €<span id="total">0.00</span></h2>
            <h3>Faltam: €<span id="falta">100.00</span> para alcançar os 100€</h3>
        </div>

        <div class="right-table">
            <h2>Itens Comuns</h2>
            <table id="itensComuns">
                <thead>
                    <tr>
                        <th>Nome</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Itens comuns da lista de compras -->
                    {% for item, preco in precos.items() %}
                        <tr id="item-{{ item }}">
                            <td>{{ item }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>

        // Função para adicionar uma nova linha à tabela
        function adicionarLinha() {
            const tabelaCorpo = document.getElementById("tabelaCorpo");

            const row = document.createElement("tr");

            // Criar células para nome, preço, quantidade e total
            const nomeCell = document.createElement("td");
            nomeCell.contentEditable = true;
            nomeCell.innerText = "";

            // Evento para sugerir preços em tempo real enquanto digita
            nomeCell.addEventListener('input', function () {
                sugerirPreco(nomeCell);  // Chama a função para sugerir o preço enquanto digita
            });

            const precoCell = document.createElement("td");
            precoCell.contentEditable = true;
            precoCell.innerText = "0.00";

            const quantidadeCell = document.createElement("td");
            quantidadeCell.contentEditable = true;
            quantidadeCell.innerText = "0";

            const totalCell = document.createElement("td");
            totalCell.innerText = "0.00";

            // Adicionar células à linha
            row.appendChild(nomeCell);
            row.appendChild(precoCell);
            row.appendChild(quantidadeCell);
            row.appendChild(totalCell);

            tabelaCorpo.appendChild(row);

            // Atualizar o total
            atualizarTotal();
        }

        function sugerirPreco(nomeCell) {
            const nomeItem = nomeCell.innerText.trim().toLowerCase();
            const precoCell = nomeCell.nextElementSibling;

            // Envia o nome do item para o servidor Flask para sugerir o preço
            fetch('/sugerir_preco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome: nomeItem })
            })
            .then(response => response.json())
            .then(data => {
                precoCell.innerText = data.preco.toFixed(2);
                
                // Se o preço for sugerido, adiciona a classe para indicar que é uma estimativa
                if (data.preco !== 0) {
                    precoCell.classList.add('preco-estimado');
                } else {
                    precoCell.classList.remove('preco-estimado');
                }
                
                // Atualiza o total após sugerir o preço
                atualizarTotal();
            });
        }

        // Função para remover a linha selecionada
        function removerLinha() {
            const linhaSelecionada = document.querySelector('.selected');
            
            if (linhaSelecionada) {
                linhaSelecionada.remove();
                // Atualizar o total após remoção
                atualizarTotal();
            } else {
                alert("Selecione uma linha para remover.");
            }
        }

        // Função para atualizar o total quando qualquer célula for modificada
        function atualizarTotal() {
            let total = 0;

            const rows = document.querySelectorAll("#tabelaCorpo tr");
            rows.forEach(row => {
                const nome = row.cells[0].innerText;
                const preco = parseFloat(row.cells[1].innerText) || 0;
                const quantidade = parseInt(row.cells[2].innerText) || 0;
                const itemTotal = preco * quantidade;

                row.cells[3].innerText = itemTotal.toFixed(2);
                total += itemTotal;

                // Marcar o item como riscado na tabela da direita quando adicionado
                if (quantidade > 0) {
                    document.getElementById(`item-${nome.toLowerCase()}`).classList.add('riscado');
                } else {
                    document.getElementById(`item-${nome.toLowerCase()}`).classList.remove('riscado');
                }
            });

            // Atualiza o valor total e o que falta para os 100€
            document.getElementById("total").innerText = total.toFixed(2);
            document.getElementById("falta").innerText = (100 - total).toFixed(2);
        }

        // Função para monitorar mudanças nas células e atualizar o total
        document.getElementById("tabelaItens").addEventListener("input", function(event) {
            if (event.target.tagName === "TD") {
                atualizarTotal();
            }
        });

    </script>

</body>
</html>
